# Frame Application SSL Virtual Host Configuration
# Generated for: [% app_name %]
# User: [% username %]
# Domain: [% domain %]
# Port: [% port %]
# Generated: [% timestamp %]

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName [% domain %]
    [% IF aliases %]
    ServerAlias [% aliases %]
    [% END %]

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# HTTPS Virtual Host
<VirtualHost *:443>
    ServerName [% domain %]
    [% IF aliases %]
    ServerAlias [% aliases %]
    [% END %]

    # Document root (for static files if needed)
    DocumentRoot /var/frame/instances/[% username %]/apps/[% app_name %]/public

    # Logging
    ErrorLog /var/log/frame/[% username %]/[% app_name %]-error.log
    CustomLog /var/log/frame/[% username %]/[% app_name %]-access.log combined

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile [% ssl_cert %]
    SSLCertificateKeyFile [% ssl_key %]
    [% IF ssl_chain %]
    SSLCertificateChainFile [% ssl_chain %]
    [% END %]

    # Modern SSL settings
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=63072000" env=HTTPS

    # Set environment variable for Frame headers
    SetEnv FRAME_APP 1

    # Proxy configuration
    ProxyPreserveHost On

    # WebSocket support over SSL
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*)$ ws://127.0.0.1:[% port %]/$1 [P,L]

    # Proxy all requests to Frame instance
    ProxyPass / http://127.0.0.1:[% port %]/
    ProxyPassReverse / http://127.0.0.1:[% port %]/

    # Pass SSL information to backend
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-SSL "on"

    # Error pages
    ErrorDocument 502 /frame-error/502.html
    ErrorDocument 503 /frame-error/503.html
    ErrorDocument 504 /frame-error/504.html

    # Health check endpoint bypass
    <Location "/.frame/health">
        SetEnv nolog
    </Location>

    # Security - deny access to hidden files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    # Cache control for static assets
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000"
    </LocationMatch>
</VirtualHost>
